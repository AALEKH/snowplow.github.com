<!DOCTYPE html>
<html>
<head>
	
	<title>Basic recipes - Snowplow Analytics</title>
	

	<link rel="icon" type="image/x-icon" href="/favicon.ico" />

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="description" content="" />
	<link href="/static/css/styles.css" type="text/css" rel="stylesheet" />
	<link href="/static/css/pygments.css" type="text/css" rel="stylesheet" />
	
	<!--For the homepage slider-->
	<link rel="stylesheet" href="/static/css/nivo-slider.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="/static/css/nivo-slider-theme-default.css" type="text/css" media="screen" />
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script src="/static/js/jquery-nivo-slider-pack.js" type="text/javascript" ></script>
	<!--MathJax http://www.mathjax.org/-->
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_HTMLorMML.js"></script>
	<script type="text/javascript">
		MathJax.Hub.Config({
	      tex2jax: {
	        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
	      }
	    });
	    MathJax.Hub.Queue(function() {
	        var all = MathJax.Hub.getAllJax(), i;
	        for(i=0; i < all.length; i += 1) {
	            all[i].SourceElement().parentNode.className += ' has-jax';
	        }
    	});
	</script>
	<!-- end mathjax -->
	<!-- typekit -->
	<script type="text/javascript" src="//use.typekit.net/noo1diw.js"></script>
	<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<!-- end typekit -->
</head>
<body>
	<!-- Google Tag Manager -->
	<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-DLRG"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-DLRG');</script>
	<!-- End Google Tag Manager -->
	<div id="universe">
		<div id="container">
			<div id="header" class="span-24">
  <div id="logo">
    <h1><a href="/"><img src="/static/img/snowplow-logo-website.png" title="Snowplow Analytics" /></a></h1>
  </div>
  <div id="menu" class="span-15">
    <ul>
      <li ><a href="/product/index.html">Product</a></li>
      <li ><a href="/services/index.html">Services</a></li>
      <li  class="active" ><a href="/analytics/index.html">Analytics</a></li>
      <li ><a href="/technology/index.html">Technology</a></li>
      <li ><a href="/blog.html">Blog</a></li>
      <li ><a id="mail" href="/about/index.html">About</a></li>
    </ul>
  </div>
</div>
	
			<div id="contents">
<a name='top'><h1>Bread and butter web analytics queries</h1></a>
<p>The following queries return basic web analytics data that someone could expect from any standard web analytics package. These are <em>not</em> the queries that Snowplow was designed to perform: we built Snowplow to enable analysts to run queries on web analytics data that are <strong>not</strong> possible with other web analytics programs. These queries return the results that <strong>all</strong> web analytics queries return. However, running them can be useful for an analyst to validate Snowplow has been setup correctly (by comparing the output against e.g. Google Analytics), and help her get familiar with writing queries in Snowplow.</p>

<p>For users who are getting started with Snowplow, but are not that familiar with SQL, we recommend consulting our <a href='/analytics/tools-and-techniques/beginners-guide-to-using-sql-to-query-snowplow-data.html'>quick-start guide to using SQL</a>.</p>

<p>The following queries will work with both Redshift and PostgreSQL. It should not take much to edit them so that they work with Hive.</p>

<ol>
<li><a href='#counting-unique-visitors'>Number of unique visitors</a></li>

<li><a href='#counting-visits'>Number visits</a></li>

<li><a href='#counting-pageviews'>Number of pageviews</a></li>

<li><a href='#counting-events'>Number of events</a></li>

<li><a href='#pages-per-visit'>Pages per visit</a></li>

<li><a href='#bounce-rate'>Bounce rate</a></li>

<li><a href='#new-visits'>% New visits</a></li>

<li><a href='#duration'>Average visitor duration</a></li>

<li><a href='#language'>Demographics: language</a></li>

<li><a href='#location'>Demographics: location</a></li>

<li><a href='#new-vs-returning'>Behavior: new vs returning</a></li>

<li><a href='#frequency'>Behavior: frequency</a></li>

<li><a href='#recency'>Behavior: recency</a></li>

<li><a href='#engagement'>Behavior: engagement</a></li>

<li><a href='#browser'>Technology: browser</a></li>

<li><a href='#os'>Technology: operating system</a></li>

<li><a href='#mobile'>Technology: mobile</a></li>
</ol>
<a name='counting-unique-visitors'><h2>1. Number of unique visitors </h2></a>
<p>The number of unique visitors can be calculated by summing the number of distinct <code>domain_userid</code>s in a specified time period. (Because each user is assigned a unique domain_userid, based on a lack of Snowplow tracking cookies on their browser):</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span><span class='p'>))</span> <span class='k'>as</span> <span class='ss'>&quot;Uniques&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='uniques-by-day' src='/static/img/analytics/basic-recipes/uniques-by-day-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='counting-visits'><h2>2. Number of visits</h2></a>
<p>Because each user might visit a site more than once, summing the number of <code>domain_userid</code>s returns the number if <em>visitors</em>, NOT the number of <em>visits</em>. Every time a user visits the site, however, Snowplow assigns that session with a <code>domain_sessionidx</code> (e.g. <code>1</code> for their first visit, <code>2</code> for their second.) Hence, to count the number of visits in a time period, we concatenate the unique <code>domain_userid</code> with the <code>domain_sessionidx</code> and then count the number of distinct concatenated entry in the events table:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span> <span class='o'>||</span> <span class='s1'>&#39;-&#39;</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span><span class='p'>))</span> <span class='k'>as</span> <span class='ss'>&quot;Visits&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='visits-by-day' src='/static/img/analytics/basic-recipes/visits-by-day-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='counting-pageviews'><h2>3. Number of page views</h2></a>
<p>Page views are one type of event that are stored in the Snowplow events table. They can easily be identified using the <code>event</code> field, which is set to &#8216;page_view&#8217;.</p>

<p>To count the number of page views by day, then we simply execute the following query:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span> 
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;page_views&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>AND</span> <span class='n'>event</span> <span class='o'>=</span> <span class='s1'>&#39;page_view&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='pageviews-by-day' src='/static/img/analytics/basic-recipes/pageviews-by-day-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='counting-events'><h2>4. Number of events</h2></a>
<p>Although the number of page views is a standard metric in web analytics, this reflects the web&#8217;s history as a set of hyperlinked documents rather than the modern reality of web applications that are comprise lots of AJAX events (that need not necessarily result in a page load.)</p>

<p>As a result, counting the total number of events (including page views but also other AJAX events) is actually a more meaningful thing to do than to count the number of page views, as we have done above. We recommend setting up Snowplow so that <em>all</em> events / actions that a user takes are tracked. Hence, running the below queries should return a total sum of events on the site by time period:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='n'>event</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;Number&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='events-by-day' src='/static/img/analytics/basic-recipes/events-by-day-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='pages-per-visit'><h2>5. Pages per visit</h2></a>
<p>The number of pages per visit can be calculated by visit very straightforwardly:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span> <span class='o'>||</span> <span class='s1'>&#39;-&#39;</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span> <span class='k'>AS</span> <span class='ss'>&quot;session&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;pages_visited&quot;</span>
<span class='k'>FROM</span> <span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>event</span> <span class='o'>=</span> <span class='s1'>&#39;page_view&#39;</span>
<span class='k'>AND</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span> 
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
</code></pre></div>
<p>We can then aggregate our data by number of pages per visit, to produce a frequency table:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>CREATE</span> <span class='k'>VIEW</span> <span class='n'>basic_recipes</span><span class='p'>.</span><span class='n'>pages_per_visit</span> <span class='k'>AS</span>
<span class='k'>SELECT</span>
<span class='n'>pages_visited</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;frequency&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span> <span class='o'>||</span> <span class='s1'>&#39;-&#39;</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span> <span class='k'>AS</span> <span class='ss'>&quot;session&quot;</span><span class='p'>,</span>
	<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;pages_visited&quot;</span>
	<span class='k'>FROM</span> <span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>event</span> <span class='o'>=</span> <span class='s1'>&#39;page_view&#39;</span>
	<span class='k'>AND</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span> 
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='p'>)</span> <span class='k'>AS</span> <span class='n'>page_view_per_visit</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='page-views-per-visit-frequency-table-chartio' src='/static/img/analytics/basic-recipes/page-views-per-visit-frequency-table-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='bounce-rate'><h2>6. Bounce rate</h2></a>
<p>First we need to identify all the sessions that were &#8216;bounces&#8217;. These are visits where there is only a single event captured: the initial page view:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;time_first_touch&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;number_of_events&quot;</span><span class='p'>,</span>
<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='k'>count</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='mi'>1</span> <span class='k'>ELSE</span> <span class='mi'>0</span> <span class='k'>END</span> <span class='k'>AS</span> <span class='n'>bounces</span>
<span class='k'>FROM</span> <span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>This query returns a line of data for every session. For each, it logs a timestamp, the number of events, and a flag that is set to 1 if the visitor bounced.</p>

<p>To calculate bounce rate by day, we take the above table, aggregate the results by day, sum the number of bounces and divide it by the total number of sessions:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>time_first_touch</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='k'>SUM</span><span class='p'>(</span><span class='n'>bounces</span><span class='p'>)::</span><span class='nb'>REAL</span><span class='o'>/</span><span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Bounce rate&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;time_first_touch&quot;</span><span class='p'>,</span>
	<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;number_of_events&quot;</span><span class='p'>,</span>
	<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='k'>count</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='mi'>1</span> <span class='k'>ELSE</span> <span class='mi'>0</span> <span class='k'>END</span> <span class='k'>AS</span> <span class='n'>bounces</span>
	<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>v</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>Note that we have to cast sum(bounces) as a &#8216;real&#8217; number, to force Redshift / PostgreSQL to output a real number rather than an integer for the bounce rate.</p>

<p>In ChartIO:</p>

<p><img alt='fraction-of-visits-per-day-that-bounce' src='/static/img/analytics/basic-recipes/fraction-of-visits-per-day-that-bounce-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='new-visits'><h2>7. % New visits</h2></a>
<p>A new visit is easily identified as a visit where the domain_sessionidx = 1. Hence, to calculate the % of new visits, we need to sum all the visits where <code>domain_sessionidx</code> = 1 and divide by the total number of visits, in the time period.</p>

<p>First, we create a table with every visit stored, and identify which visits were &#8220;new&#8221;:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>AS</span> <span class='s2'>&quot;time_first_touch&quot;</span><span class='p'>,</span>
<span class='n'>domain_userid</span><span class='p'>,</span> 
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='mi'>1</span> <span class='k'>ELSE</span> <span class='mi'>0</span> <span class='n'>END</span> <span class='k'>AS</span> <span class='s2'>&quot;first_visit&quot;</span>
<span class='k'>FROM</span> <span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='n'>domain_userid</span><span class='p'>,</span> <span class='n'>domain_sessionidx</span><span class='p'>;</span>
</code></pre></div>
<p>Then we aggregate the visits over our desired time period, and calculate the fraction of them that are new:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='nf'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>time_first_touch</span><span class='p'>)</span> <span class='k'>AS</span> <span class='s2'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='nf'>SUM</span><span class='p'>(</span><span class='n'>first_visit</span><span class='p'>)::</span><span class='kt'>REAL</span><span class='o'>/</span><span class='nf'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;fraction_of_visits_that_are_new&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>AS</span> <span class='s2'>&quot;time_first_touch&quot;</span><span class='p'>,</span>
	<span class='n'>domain_userid</span><span class='p'>,</span> 
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='mi'>1</span> <span class='k'>ELSE</span> <span class='mi'>0</span> <span class='n'>END</span> <span class='k'>AS</span> <span class='s2'>&quot;first_visit&quot;</span>
	<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='n'>domain_userid</span><span class='p'>,</span> <span class='n'>domain_sessionidx</span><span class='p'>)</span> <span class='n'>v</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='fraction-of-visits-per-day-where-the-visitor-is-new' src='/static/img/analytics/basic-recipes/fraction-of-visits-per-day-where-the-visitor-is-new-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='duration'><h2>8. Average visitor duration</h2></a>
<p>To calculate this, 1st we need to calculate the duration of every visit:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;start_time&quot;</span><span class='p'>,</span>
<span class='nf'>MAX</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;finish_time&quot;</span><span class='p'>,</span>
<span class='nf'>MAX</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='o'>-</span> <span class='nf'>min</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;duration&quot;</span>
<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>Then we simply average visit durations over the time period we&#8217;re interested e.g. by day:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='nf'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>start_time</span><span class='p'>)</span> <span class='k'>AS</span> <span class='s2'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='nf'>AVG</span><span class='p'>(</span><span class='n'>duration</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>1000000</span> <span class='k'>as</span> <span class='s2'>&quot;average_visit_duration_seconds&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;start_time&quot;</span><span class='p'>,</span>
	<span class='nf'>MAX</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;finish_time&quot;</span><span class='p'>,</span>
	<span class='nf'>MAX</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='o'>-</span> <span class='nf'>min</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;duration&quot;</span>
	<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>v</span>
<span class='k'>group</span> <span class='k'>by</span> <span class='mi'>1</span>
<span class='k'>order</span> <span class='k'>by</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p><a href='#top'>Back to top</a></p>
<a name='language'><h2>9. Demographics: language</h2></a>
<p>For each event the browser language is stored in the <code>br_language</code> field. As a result, counting the number of visitors in a time period by language is trivial:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>br_lang</span><span class='p'>,</span>
<span class='nf'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span><span class='p'>))</span> <span class='k'>as</span> <span class='s2'>&quot;visitors&quot;</span>
<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='n'>br_lang</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>2</span> <span class='k'>DESC</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='visitors-by-language-chartio' src='/static/img/analytics/basic-recipes/visitors-by-language-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='location'><h2>10. Demographics: location</h2></a>
<p>We can identify the geographic location of users using the <code>geo_country</code>, <code>geo_region</code>, <code>geo_city</code>, <code>geo_zipcode</code>, <code>geo_latitude</code> and <code>geo_longitude</code> fields.</p>

<p>To calculate the number of visitors in the last month by country, simply execute:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>geo_country</span><span class='p'>,</span>
<span class='nf'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span><span class='p'>))</span> <span class='k'>as</span> <span class='s2'>&quot;visitors&quot;</span>
<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>2</span> <span class='k'>DESC</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='visitors-by-country' src='/static/img/analytics/basic-recipes/visitors-by-country-chartio.png' /></p>

<p>To create a geographical plot, you&#8217;ll need to use another tool like <a href='http://cran.r-project.org/'>R</a> or <a href='http://www.tableausoftware.com/'>Tableau</a>.</p>

<p><a href='#top'>Back to top</a></p>
<a name='new-vs-returning'><h2>11. Behavior: new vs returning</h2></a>
<p>Within a given time period, we can compare the number of new visitors (for whom <code>domain_sessionidx</code> = 1) with returning visitors (for whom <code>domain_sessionidx</code> &gt; 1):</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='n'>time_first_touch</span><span class='p'>,</span>
<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;new&#39;</span> <span class='k'>ELSE</span> <span class='s1'>&#39;returning&#39;</span> <span class='k'>END</span> <span class='k'>AS</span> <span class='ss'>&quot;new_vs_returning&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='n'>domain_userid</span><span class='p'>,</span> <span class='n'>domain_sessionidx</span><span class='p'>;</span>
</code></pre></div>
<p>Then we can aggregate them by time period, to get the total new vs returning e.g. by day:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>DATE_TRUNC</span><span class='p'>(</span><span class='s1'>&#39;day&#39;</span><span class='p'>,</span> <span class='n'>time_first_touch</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;Date&quot;</span><span class='p'>,</span>
<span class='k'>SUM</span><span class='p'>(</span><span class='n'>first_visit</span><span class='p'>)::</span><span class='nb'>REAL</span><span class='o'>/</span><span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;fraction_of_visits_that_are_new&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>AS</span> <span class='ss'>&quot;time_first_touch&quot;</span><span class='p'>,</span>
	<span class='n'>domain_userid</span><span class='p'>,</span> 
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='mi'>1</span> <span class='k'>ELSE</span> <span class='mi'>0</span> <span class='k'>END</span> <span class='k'>AS</span> <span class='ss'>&quot;first_visit&quot;</span>
	<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='n'>domain_userid</span><span class='p'>,</span> <span class='n'>domain_sessionidx</span><span class='p'>)</span> <span class='n'>v</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='new-vs-returning-visits-by-day' src='/static/img/analytics/basic-recipes/new-vs-returning-visits-by-day-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='frequency'><h2>12. Behavior: frequency</h2></a>
<p>We can plot the distribution of visits in a time period by the number of visits each visitor has performed:</p>
<div class='highlight'><pre><code class='sql'><span class='k'>SELECT</span>
<span class='n'>domain_sessionidx</span> <span class='k'>as</span> <span class='ss'>&quot;Number of visits&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span><span class='p'>))</span> <span class='k'>as</span> <span class='ss'>&quot;Frequency&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='distribution-of-visitors-by-number-of-visits' src='/static/img/analytics/basic-recipes/distribution-of-visitors-by-number-of-visits.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='recency'><h2>13. Behavior: recency</h2></a>
<p>We can plot the distribution of visits by the number of days since the previous visit. To do this, we first identify all the visits in our time period:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span> <span class='o'>-</span> <span class='mi'>1</span> <span class='k'>as</span> <span class='s2'>&quot;previous_domain_sessionidx&quot;</span><span class='p'>,</span>
<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;time_first_touch&quot;</span>
<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>We can join the above table with a similar table, but join each visit to data for the previous visit, so we can calculate the number of days between visits:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>n</span><span class='p'>.</span><span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>n</span><span class='p'>.</span><span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='nf'>EXTRACT</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='k'>as</span> <span class='s2'>&quot;days_between_visits&quot;</span><span class='p'>,</span>
<span class='k'>CASE</span>
	<span class='k'>WHEN</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;0&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;1&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>2</span> <span class='k'>THEN</span> <span class='s1'>&#39;2&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>3</span> <span class='k'>THEN</span> <span class='s1'>&#39;3&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>4</span> <span class='k'>THEN</span> <span class='s1'>&#39;4&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>5</span> <span class='k'>THEN</span> <span class='s1'>&#39;5&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>10</span> <span class='k'>THEN</span> <span class='s1'>&#39;6-10&#39;</span>
	<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>25</span> <span class='k'>THEN</span> <span class='s1'>&#39;11-25&#39;</span>
	<span class='k'>ELSE</span> <span class='s1'>&#39;25+&#39;</span> <span class='n'>END</span> <span class='k'>as</span> <span class='s2'>&quot;Days between visits&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span> <span class='o'>-</span> <span class='mi'>1</span> <span class='k'>as</span> <span class='s2'>&quot;previous_domain_sessionidx&quot;</span><span class='p'>,</span>
	<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;time_first_touch&quot;</span>
	<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>n</span>
<span class='k'>LEFT</span> <span class='k'>JOIN</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='nf'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;time_first_touch&quot;</span>
	<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>p</span> <span class='k'>on</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>previous_domain_sessionidx</span> <span class='o'>=</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>domain_sessionidx</span>
<span class='k'>and</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>domain_userid</span> <span class='o'>=</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>domain_userid</span><span class='p'>;</span>
</code></pre></div>
<p>Finally, we group the results by the number of days between visits, to plot a frequency table:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='ss'>&quot;Days between visits&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Number of visits&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>n</span><span class='p'>.</span><span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>n</span><span class='p'>.</span><span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>EXTRACT</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='k'>as</span> <span class='ss'>&quot;days_between_visits&quot;</span><span class='p'>,</span>
	<span class='k'>CASE</span>
		<span class='k'>WHEN</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>domain_sessionidx</span> <span class='o'>=</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;0&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;1&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>2</span> <span class='k'>THEN</span> <span class='s1'>&#39;2&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>3</span> <span class='k'>THEN</span> <span class='s1'>&#39;3&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>4</span> <span class='k'>THEN</span> <span class='s1'>&#39;4&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>5</span> <span class='k'>THEN</span> <span class='s1'>&#39;5&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>10</span> <span class='k'>THEN</span> <span class='s1'>&#39;6-10&#39;</span>
		<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>epoch</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='n'>n</span><span class='p'>.</span><span class='n'>time_first_touch</span> <span class='o'>-</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>time_first_touch</span><span class='p'>))</span><span class='o'>/</span><span class='mi'>3600</span><span class='o'>/</span><span class='mi'>24</span> <span class='o'>&lt;</span> <span class='mi'>25</span> <span class='k'>THEN</span> <span class='s1'>&#39;11-25&#39;</span>
		<span class='k'>ELSE</span> <span class='s1'>&#39;25+&#39;</span> <span class='k'>END</span> <span class='k'>as</span> <span class='ss'>&quot;Days between visits&quot;</span>
	<span class='k'>FROM</span> <span class='p'>(</span>
		<span class='k'>SELECT</span>
		<span class='n'>domain_userid</span><span class='p'>,</span>
		<span class='n'>domain_sessionidx</span><span class='p'>,</span>
		<span class='n'>domain_sessionidx</span> <span class='o'>-</span> <span class='mi'>1</span> <span class='k'>as</span> <span class='ss'>&quot;previous_domain_sessionidx&quot;</span><span class='p'>,</span>
		<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;time_first_touch&quot;</span>
		<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
		<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
		<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
	<span class='p'>)</span> <span class='n'>n</span>
	<span class='k'>LEFT</span> <span class='k'>JOIN</span> <span class='p'>(</span>
		<span class='k'>SELECT</span>
		<span class='n'>domain_userid</span><span class='p'>,</span>
		<span class='n'>domain_sessionidx</span><span class='p'>,</span>
		<span class='k'>MIN</span><span class='p'>(</span><span class='n'>collector_tstamp</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;time_first_touch&quot;</span>
		<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
		<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
	<span class='p'>)</span> <span class='n'>p</span> <span class='k'>ON</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>previous_domain_sessionidx</span> <span class='o'>=</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>domain_sessionidx</span>
	<span class='k'>AND</span> <span class='n'>n</span><span class='p'>.</span><span class='n'>domain_userid</span> <span class='o'>=</span> <span class='n'>p</span><span class='p'>.</span><span class='n'>domain_userid</span>
<span class='p'>)</span> <span class='n'>t</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='days-since-last-visit-in-chartio' src='/static/img/analytics/basic-recipes/days-since-last-visit-in-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='engagement'><h2>14. Behavior: engagement</h2></a>
<p>Google Analytics provides two sets of metrics to indicate <em>engagement</em>:</p>

<ol>
<li>Visit duration</li>

<li>Page depth (i.e. number of pages visited per session)</li>
</ol>

<p>Both of these are flakey and unsophisticated measures of engagement. Nevertheless, they are easy to report on in Snowplow. To plot visit duration, we execute the following query:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='k'>CASE</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>1800</span> <span class='k'>THEN</span> <span class='s1'>&#39;g. 1801+ seconds&#39;</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>600</span> <span class='k'>THEN</span> <span class='s1'>&#39;f. 601-1800 seconds&#39;</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>180</span> <span class='k'>THEN</span> <span class='s1'>&#39;e. 181-600 seconds&#39;</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>60</span> <span class='k'>THEN</span> <span class='s1'>&#39;d. 61 - 180 seconds&#39;</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>30</span> <span class='k'>THEN</span> <span class='s1'>&#39;c. 31-60 seconds&#39;</span> 
	<span class='k'>WHEN</span> <span class='k'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='k'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='k'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>10</span> <span class='k'>THEN</span> <span class='s1'>&#39;b. 11-30 seconds&#39;</span> 
	<span class='k'>ELSE</span> <span class='s1'>&#39;a. 0-10 seconds&#39;</span> <span class='k'>END</span> <span class='k'>AS</span> <span class='ss'>&quot;Visit duration&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>;</span>
</code></pre></div>
<p>Then we aggregate the results for each bucket, so we have frequency by bucket:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='s2'>&quot;Visit duration&quot;</span><span class='p'>,</span>
<span class='nf'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='s2'>&quot;Number of visits&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>CASE</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>1800</span> <span class='k'>THEN</span> <span class='s1'>&#39;g. 1801+ seconds&#39;</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>600</span> <span class='k'>THEN</span> <span class='s1'>&#39;f. 601-1800 seconds&#39;</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>180</span> <span class='k'>THEN</span> <span class='s1'>&#39;e. 181-600 seconds&#39;</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>60</span> <span class='k'>THEN</span> <span class='s1'>&#39;d. 61 - 180 seconds&#39;</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>30</span> <span class='k'>THEN</span> <span class='s1'>&#39;c. 31-60 seconds&#39;</span> 
		<span class='k'>WHEN</span> <span class='nf'>extract</span><span class='p'>(</span><span class='n'>EPOCH</span> <span class='k'>FROM</span> <span class='p'>(</span><span class='nf'>MAX</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)</span><span class='o'>-</span><span class='nf'>MIN</span><span class='p'>(</span><span class='n'>dvce_tstamp</span><span class='p'>)))</span> <span class='o'>&gt;</span> <span class='mi'>10</span> <span class='k'>THEN</span> <span class='s1'>&#39;b. 11-30 seconds&#39;</span> 
		<span class='k'>ELSE</span> <span class='s1'>&#39;a. 0-10 seconds&#39;</span> <span class='n'>END</span> <span class='k'>AS</span> <span class='s2'>&quot;Visit duration&quot;</span>
	<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>t</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>We can then plot the results in ChartIO:</p>

<p><img alt='visits-by-duration-chartio' src='/static/img/analytics/basic-recipes/visits-by-duration-chartio.png' /></p>

<p>We can also look at the number of page views per visit:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSLQ */</span> 
<span class='k'>select</span>
<span class='n'>domain_userid</span><span class='p'>,</span>
<span class='n'>domain_sessionidx</span><span class='p'>,</span>
<span class='k'>count</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Page views per visit&quot;</span>
<span class='k'>from</span> <span class='n'>events</span>
<span class='k'>where</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>and</span> <span class='n'>event</span> <span class='o'>=</span> <span class='s1'>&#39;page_view&#39;</span>
<span class='k'>group</span> <span class='k'>by</span> <span class='n'>domain_userid</span><span class='p'>,</span> <span class='n'>domain_sessionidx</span><span class='p'>;</span>
</code></pre></div>
<p>We then aggregate those results together by the number of page views per visit</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSLQ */</span>
<span class='k'>SELECT</span>
<span class='ss'>&quot;Page views per visit&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Number of visits&quot;</span>
<span class='k'>FROM</span> <span class='p'>(</span>
	<span class='k'>SELECT</span>
	<span class='n'>domain_userid</span><span class='p'>,</span>
	<span class='n'>domain_sessionidx</span><span class='p'>,</span>
	<span class='k'>COUNT</span><span class='p'>(</span><span class='o'>*</span><span class='p'>)</span> <span class='k'>as</span> <span class='ss'>&quot;Page views per visit&quot;</span>
	<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
	<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
	<span class='k'>AND</span> <span class='n'>event</span> <span class='o'>=</span> <span class='s1'>&#39;page_view&#39;</span>
	<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span>
<span class='p'>)</span> <span class='n'>t</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='visits-in-the-last-month-by-page-depth' src='/static/img/analytics/basic-recipes/visits-in-last-month-by-page-depth-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='browser'><h2>15. Technology: browser</h2></a>
<p>Browser details are stored in the events table in the <code>br_name</code>, <code>br_family</code>, <code>br_version</code>, <code>br_type</code>, <code>br_renderingengine</code>, <code>br_features</code> and <code>br_cookies</code> fields.</p>

<p>Looking at the distribution of visits by browser is straightforward:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>SELECT</span>
<span class='n'>br_family</span> <span class='k'>as</span> <span class='ss'>&quot;Browser&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span><span class='p'>))</span> <span class='k'>as</span> <span class='ss'>&quot;Visits&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span>
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>2</span> <span class='k'>DESC</span><span class='p'>;</span>
</code></pre></div>
<p>In ChartIO:</p>

<p><img alt='visits-by-browser-type' src='/static/img/analytics/basic-recipes/visits-by-browser-type-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='os'><h2>16. Technology: operating system</h2></a>
<p>Operating system details are stored in the events table in the <code>os_name</code>, <code>os_family</code> and <code>os_manufacturer</code> fields.</p>

<p>Looking at the distribution of visits by operating system is straightforward:</p>
<div class='highlight'><pre><code class='sql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>CREATE</span> <span class='k'>VIEW</span> <span class='n'>basic_recipes</span><span class='p'>.</span><span class='n'>technology_os</span> <span class='k'>AS</span>
<span class='k'>SELECT</span> 
<span class='n'>os_name</span> <span class='k'>as</span> <span class='ss'>&quot;Operating System&quot;</span><span class='p'>,</span>
<span class='k'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span><span class='p'>))</span> <span class='k'>as</span> <span class='ss'>&quot;Visits&quot;</span>
<span class='k'>FROM</span> <span class='ss'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='nb'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span> 
<span class='k'>ORDER</span> <span class='k'>BY</span> <span class='mi'>2</span> <span class='k'>DESC</span><span class='p'>;</span> 
</code></pre></div>
<p>Again, we can plot the results in ChartIO:</p>

<p><img alt='visits-by-operating-system' src='/static/img/analytics/basic-recipes/visits-by-operating-system-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
<a name='mobile'><h2>17. Technology: mobile</h2></a>
<p>To work out how the number of visits in a given time period splits between visitors on mobile and those not, simply execute the following query:</p>
<div class='highlight'><pre><code class='mysql'><span class='cm'>/* Redshift / PostgreSQL */</span>
<span class='k'>CREATE</span> <span class='n'>VIEW</span> <span class='n'>basic_recipes</span><span class='p'>.</span><span class='n'>technology_mobile</span> <span class='k'>AS</span>
<span class='k'>SELECT</span> 
<span class='k'>CASE</span> <span class='k'>WHEN</span> <span class='n'>dvce_ismobile</span><span class='o'>=</span><span class='mi'>1</span> <span class='k'>THEN</span> <span class='s1'>&#39;mobile&#39;</span> <span class='k'>ELSE</span> <span class='s1'>&#39;desktop&#39;</span> <span class='n'>END</span> <span class='k'>AS</span> <span class='s2'>&quot;Device type&quot;</span><span class='p'>,</span>
<span class='nf'>COUNT</span><span class='p'>(</span><span class='k'>DISTINCT</span><span class='p'>(</span><span class='n'>domain_userid</span> <span class='o'>||</span> <span class='n'>domain_sessionidx</span><span class='p'>))</span> <span class='k'>as</span> <span class='s2'>&quot;Visits&quot;</span>
<span class='k'>FROM</span> <span class='s2'>&quot;atomic&quot;</span><span class='p'>.</span><span class='n'>events</span>
<span class='k'>WHERE</span> <span class='n'>collector_tstamp</span> <span class='o'>&gt;</span> <span class='k'>current_date</span> <span class='o'>-</span> <span class='kt'>integer</span> <span class='s1'>&#39;31&#39;</span>
<span class='k'>GROUP</span> <span class='k'>BY</span> <span class='mi'>1</span><span class='p'>;</span>
</code></pre></div>
<p>Plotting the results in ChartIO:</p>

<p><img alt='split-in-visits-by-mobile-vs-desktop' src='/static/img/analytics/basic-recipes/split-in-visits-by-mobile-vs-desktop-chartio.png' /></p>

<p><a href='#top'>Back to top</a></p>
</div>

 <div id="sidebar">
	<h1>Analysts Cookbook</h1>
	<p>
		<a href="/analytics/index.html" class="active">Overview</a>
		
		<ul>
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
						
							
							<li><a href="/analytics/index.html">The Snowplow Analytis Cookbook</a></li>
									
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
						
							
							<li><a href="/analytics/snowplow-data-production.html">Data production</a></li>
									
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
						
							
							<li><a href="/analytics/snowplow-data-storage.html">Data storage</a></li>
									
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
						
							
							<li><a href="/analytics/snowplow-table-structure.html">Data structure</a></li>
									
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
						
							
							<li class="active"><a href="/analytics/basic-recipes.html" class="active">Basic recipes</a></li>
									
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
									
					
				
					
				
					
				
					
				
					
									
					
				
					
									
					
				
					
									
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
					
				
			
		</ul>
		
	</p>
	<p>
		<a href="/analytics/customer-analytics/overview.html" >Customer analytics</a>
		
	</p>
	<p>
		<a href="/analytics/catalog-analytics/overview.html" >Catalog analytics</a>
		
	</p>
	<p>
		<a href="/analytics/platform-analytics/overview.html" >Platform analytics</a>
		
	</p>
	<p>
		<a href="/analytics/tools-and-techniques/overview.html" >Tools and techniques</a>
		
	</p>
</div>

			<div id="footer">
	<p>Copyright © Snowplow Analytics Limited 2012 - 2014.  All rights reserved</p>
</div>
		</div>
	</div>
		<!-- Following Javascript function used by Disqus to count the number of comments for each blog post and display in the main index -->
	  	<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'snowplow'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
        </script>
        <!-- begin olark code -->
		<script data-cfasync="false" type='text/javascript'>/*<![CDATA[*/window.olark||(function(c){var f=window,d=document,l=f.location.protocol=="https:"?"https:":"http:",z=c.name,r="load";var nt=function(){
		f[z]=function(){
		(a.s=a.s||[]).push(arguments)};var a=f[z]._={
		},q=c.methods.length;while(q--){(function(n){f[z][n]=function(){
		f[z]("call",n,arguments)}})(c.methods[q])}a.l=c.loader;a.i=nt;a.p={
		0:+new Date};a.P=function(u){
		a.p[u]=new Date-a.p[0]};function s(){
		a.P(r);f[z](r)}f.addEventListener?f.addEventListener(r,s,false):f.attachEvent("on"+r,s);var ld=function(){function p(hd){
		hd="head";return["<",hd,"></",hd,"><",i,' onl' + 'oad="var d=',g,";d.getElementsByTagName('head')[0].",j,"(d.",h,"('script')).",k,"='",l,"//",a.l,"'",'"',"></",i,">"].join("")}var i="body",m=d[i];if(!m){
		return setTimeout(ld,100)}a.P(1);var j="appendChild",h="createElement",k="src",n=d[h]("div"),v=n[j](d[h](z)),b=d[h]("iframe"),g="document",e="domain",o;n.style.display="none";m.insertBefore(n,m.firstChild).id=z;b.frameBorder="0";b.id=z+"-loader";if(/MSIE[ ]+6/.test(navigator.userAgent)){
		b.src="javascript:false"}b.allowTransparency="true";v[j](b);try{
		b.contentWindow[g].open()}catch(w){
		c[e]=d[e];o="javascript:var d="+g+".open();d.domain='"+d.domain+"';";b[k]=o+"void(0);"}try{
		var t=b.contentWindow[g];t.write(p());t.close()}catch(x){
		b[k]=o+'d.write("'+p().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}a.P(2)};ld()};nt()})({
		loader: "static.olark.com/jsclient/loader0.js",name:"olark",methods:["configure","extend","declare","identify"]});
		/* custom configuration goes here (www.olark.com/documentation) */
		olark.identify('9752-503-10-5227');/*]]>*/</script><noscript><a href="https://www.olark.com/site/9752-503-10-5227/contact" title="Contact us" target="_blank">Questions? Feedback?</a> powered by <a href="http://www.olark.com?welcome" title="Olark live chat software">Olark live chat software</a></noscript>
		<!-- end olark code -->
		<!-- Track Olark chats in GTM (so can pass data onto Snowplow) -->
		<script type="text/javascript">
		olark('api.chat.onMessageToOperator', function(event) {
		    dataLayer.push({'event': 'olarkMessageToOperator'});
		});
		olark('api.chat.onMessageToVisitor', function(event) {
		    dataLayer.push({'event': 'olarkMessageToVisitor'});
		});
		</script>
		<!-- end track olark code -->


</body>
</html>