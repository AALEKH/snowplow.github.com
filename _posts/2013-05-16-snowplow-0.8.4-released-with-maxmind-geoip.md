---
layout: blog-post
shortenedlink: Snowplow 0.8.4 released
title: Snowplow 0.8.4 released with MaxMind geo-IP lookups
tags: snowplow maxmind geoip
author: Alex
category: Releases
---

We're pleased to announce the immediate availability of Snowplow **0.8.4**. This is a big release for us, as it adds geo-IP lookups to the Snowplow Enrichment stage, using the excellent [GeoLite City database] [geolite] from [Maxmind, Inc] [maxmind]. This has been one of the most requested features from the Snowplow community, we are delighted to add it to our Scalding ETL:

![geoip-img][geoip-img]

As well as geo-IP lookups, there are a number of other code improvements to the Hadoop ETL, plus some minor improvements to EmrEtlRunner and some updates to the Redshift table; we will go through these below the fold.

In this post we will cover:

1. [The new geo-IP capabilities](/blog/2013/03/03/snowplow-0.7.6-released-with-redshift-data-warehouse-support#geoip)
2. [Other changes](/blog/2013/03/03/snowplow-0.7.6-released-with-redshift-data-warehouse-support#other-changes)
3. [Upgrading](/blog/2013/03/03/snowplow-0.7.6-released-with-redshift-data-warehouse-support#upgrading)
4. [Getting help](/blog/2013/03/03/snowplow-0.7.6-released-with-redshift-data-warehouse-support#help)

<!--more-->

<h2><a name="geoip">1. The new geo-IP capabilities</a></h2>

The Snowplow Enrichment phase now looks up every IP address against MaxMind's [GeoLite City database] [geolite] in order to determine (where possible):

* `geo_country` - the two-letter [ISO 3166-1 alpha-2] [3166-1] country code associated with the IP address
* `geo_region` -  the two letter [ISO-3166-2] [3166-2] or [FIPS 10-4] [fips] code for the state or region associated with the IP address
* `geo_city` - the city or town name associated with the IP address
* `geo_zipcode` - the zip or postal code associated with the IP address
* `geo_latitude` - the latitude associated with the IP address
* `geo_latitude` - the latitude associated with the IP address

For further technical details it is worth reading the [GeoIP CSV Databases technical reference] [geoip-data-ref] on the MaxMind website.

<h2><a name="other-changes">2. Other changes</a></h2>

In this release we have also made some functional improvements to the Hadoop (Scalding) ETL, plus some minor improvements to EmrEtlRunner and some updates to the Redshift table. To take these in turn:

### Hadoop ETL

We have made various improvements to the Hadoop ETL:

* We have bumped the version of [referer-parser] [referer-parser] - the latest version includes a fix to better attribute Google referer URLs
* We have added truncation of `refr_urlpath`, `refr_urlquery`, `urlfragment`, to ensure they can load successfully into Redshift
* We have fixed a nasty bug where the client timestamp was being inaccurately localised to the Hadoop cluster's local time (issue #238)
* We have made the code around page URL handling more robust
* If you are running the latest version of the Clojure Collector, then the specific version number will now be extracted into the `v_collector` field

### EmrEtlRunner

We have updated EmrEtlRunner to supply the location of the MaxMind GeoLite City database to the Scalding ETL.

We have also improved the notification messages when the ETL job is started on Elastic MapReduce, and the notification message if the job should fail. 

### Redshift events table

We have updated the Redshift events table to include new fields for the geo-IP location - see [above](#geoip) for the six new field names.

Also, we have renamed the `ev_` fields in the Redshift table definition to `se_`, e.g. `se_action`. This is to make these column names consistent with our structured events terminology.

<h2><a name="upgrading">3. Upgrading</a></h2>

There are **three components** to upgrade in this release:

* The Scalding ETL, to version 0.3.0
* EmrEtlRunner, to version 0.2.0
* The Redshift events table, to version 0.2.0

Let's take these in turn:

### Hadoop ETL

If you are using EmrEtlRunner, you need to update your configuration file, `config.yml`, to the latest version of the Hadoop ETL:

	:snowplow:
	  :hadoop_etl_version: 0.3.0 # Version of the Hadoop ETL

### EmrEtlRunner

You need to upgrade your EmrEtlRunner installation to the latest code (0.8.4 release) on GitHub:

$ cd <Your Snowplow directory>
$ git clone git://github.com/snowplow/snowplow.git
$ git checkout 0.8.4

### Redshift events table

We have updated the Redshift table definition, you can find the latest version in the GitHub repository [here] [table-def-sql].

If you already have your Snowplow data in the previous version of the Redshift events table, we have written [a migration script] [migrate-sql] to handle the upgrade. **Please review this script carefully before running and check that you are happy with how it handles the upgrade.**

<h2><a name="help">4. Getting help</a></h2>

As always, if you do run into any issues or don't understand any of the above changes, please [raise an issue] [issues] or get in touch with us via [the usual channels] [talk-to-us].

You can see the full list of issues delivered in Snowplow 0.8.4 on [GitHub] [geoip-milestone].

[geolite]: http://dev.maxmind.com/geoip/legacy/geolite
[maxmind]: http://www.maxmind.com

[geoip-img]: /static/img/blog/2013/05/geoip-data.png

[3166-1]: http://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
[3166-2]: http://en.wikipedia.org/wiki/ISO_3166-2
[fips]: http://en.wikipedia.org/wiki/FIPS_10-4
[geoip-data-ref]: http://dev.maxmind.com/geoip/legacy/csv

[table-def-sql]: https://github.com/snowplow/snowplow/blob/master/4-storage/redshift-storage/sql/table-def.sql
[migrate-sql]: https://github.com/snowplow/snowplow/blob/master/4-storage/redshift-storage/sql/migrate_0.1.0_to_0.2.0.sql

[referer-parser]: https://github.com/snowplow/referer-parser

[issues]: https://github.com/snowplow/snowplow/issues
[talk-to-us]: https://github.com/snowplow/snowplow/wiki/Talk-to-us
[geoip-milestone]: https://github.com/snowplow/snowplow/issues?milestone=17&page=1&state=closed