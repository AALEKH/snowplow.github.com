---
layout: blog-post
shortenedlink: SnowPlow 0.7.4 released
title: SnowPlow 0.7.4 released for better eventstream analytics
tags: snowplow javascript tracker
author: Alex
category: Releases
---

Another week, another SnowPlow release! We're excited to announce the release of SnowPlow version **0.7.4**. The primary purpose of this release is to clean up and rationalise our event data model, in particular around **user IDs** and **event timestamps**. This release should lay the foundations for some sophisticated eventstream analytics (such as funnel analysis) going forwards.

Many thanks to SnowPlow users [Simply Business] [simply-business] and [Simon Rumble] [shermozle] (APN) for suggesting many of these changes and helping us to design them.

In this post we will cover:

## TODO: fix this

1. [Our new event timestamps](/blog/2013/02/15/snowplow-0.7.3-released#new-fields)
2. [Our new user IDs](/blog/2013/02/15/snowplow-0.7.3-released#bug-fixes)
2. [Bug fixes](/blog/2013/02/15/snowplow-0.7.3-released#bug-fixes)
3. [Breaking changes](/blog/2013/02/15/snowplow-0.7.3-released#breaking-changes)
4. [Upgrading](/blog/2013/02/15/snowplow-0.7.3-released#upgrade)

<h2><a name="new-fields">1. Our new event timestamps</a></h2>

Previously our data model included two fields - `dt` and `tm`, to track the date and time at which each event occurred. This timestamp was based on when the SnowPlow event collector _received_ the event, **not** when the tracker _sent_ the event.

There are a couple of limitations to using a collector timestamp for eventstream analysis:

1. If two events occur almost simultaneously in the client, there is no guarantee which will be received by the collector first (because of the unpredictability of the HTTP connection)
2. If a tracker (e.g. on a cellphone) batches events (e.g. when it's out of cell coverage) and then sends them in one batch, then the collector timestamp will be the same for lots of events which occurred over a longer time period on the client

For this reason, in this release we are introducing the idea of a tracker timestamp, which is set by the tracker when the event occurs, and is stored in our data model alongside the collector timestamp. This means that we now have five timestamp fields:

| Field              | Datatype | Description                                               |
|:-------------------|:---------|:----------------------------------------------------------|
| `collector_dt`     | string   | Date when the collector received the event                | 
| `collector_tm`     | string   | Time when the collector received the event                |
| `dvce_dt`          | string   | Date on the client device when the tracker sent the event |
| `dvce_tm`          | string   | Time on the client device when the tracker sent the event |
| `dvce_epoch`       | bigint   | Milliseconds since the epoch (1/1/1970) on the client device when the tracker sent the event |

Note that we track `dvce_epoch` because our `dvce_tm` field is not accurate to milliseconds; within a given user session, you can order by `dvce_epoch` to get the user's eventstream accurately ordered to the millisecond.

**A word of warning:** tracker timestamps are great for understanding the correct order of, and elapsed time between, events from a specific user session. However, they are not a safe way of understanding when a given event actually occurred, because you **cannot** trust the clocks on users' devices. So, fall back to the collector timestamp if you need to understand when events occurred across multiple users.

<h2><a name="new-fields">2. Our new user IDs</a></h2>

Historically, SnowPlow has supported a single `user_id` field. Unfortunately, there were three issues with this:

1. SnowPlow was **overloading** the field with two different meanings - if a user was running the CloudFront collector, the `user_id` field contained a user ID from a first-party cookie (set by the JavaScript tracker). If a user was running the Clojure collector, the `user_id` field contained a cross-domain user ID as set by in a third-party cookie. The JavaScript-set first-party cookie was ignored.
2. Both meanings of `user_id` were **web-specific** - when you are in a mobile app or internet-of-things world, then a cookie-based `user_id` is not possible
, we only had support for one user ID - which was either a first-party cookie ID
3. No support for a **custom** user ID - SnowPlow did not allow you to track a custom `user_id` specific to your business, such as each user's account number in your ecommerce package

In this release, we aim to fix all this by breaking user IDs out into three separate fields:

| Field              | Non-web | Web: Cf* | Web: Clj** | Description                                                                                                     |
|:-------------------|:--------|:---------|:-----------|-----------------------------------------------------------------------------------------------------------------|
| `user_id`          | Yes     | Yes      | Yes        | A custom user ID which you can set. Works in all clients                                                        |
| `domain_userid`    | No      | Yes      | Yes        | A user ID set by the JavaScript tracker in a first-party cookie. Tied to the current domain                     | 
| `network_userid`   | No      | No       | Yes        | A user ID set by the Clojure collector in a third-party cookie. Is common across a network of different domains |

To make use of the new custom user ID, you can use the following new method in the JavaScript tracker:

```javascript
_snaq.push(['setUserId', 'alex-123']); // Business-defined user ID
```

<a name="bug-fixes"><h2>2. Bug fixes</h2></a>

As well as the new fields introduced above, this release also includes an important bug fix in the JavaScript tracker, related to our newly-named `domain_userid`. Many thanks to [Angus Mark] [angus-mark] at [Simply Business] [simply-business] for alerting us to this.

Previously, the site ID as set by `setSiteId()` was used as an input into naming the first-party cookie which stores the `domain_userid`. This had the unfortunate side effect that, if you used multiple site IDs within the same domain, your visitors would end up with different 



 which are worth noting:

1. Our `logImpression()` method was not working (it was using the wrong argument names) - this has now been fixed.
2. The activity tracking (page ping) behaviour was too fragile: if a single monitoring period elapsed with no activity, then all future monitoring would be cancelled. This could easily lead to on-page activity not being recorded. This has now been fixed


<a name="breaking-changes"><h2>3. Breaking changes and deprecations</h2></a>

The following table tracks the breaking changes and deprecations in this version. **When upgrading to the latest version of the JavaScript tracker (0.10.0), please update your JavaScript tags as per the instructions below to avoid problems:**

| Type of change  | Component               | Change                         | Comment                                |
|:----------------|:------------------------|:-------------------------------|----------------------------------------|
| Breaking change | JavaScript tracker      | `setAccount()` removed         | Use `setCollectorCf()` instead         |
| Breaking change | JavaScript tracker      | `setTracker()` removed         | Use `getTrackerCf()` instead           |
| Breaking change | JavaScript tracker      | `setHeartBeatTimer()` removed  | Use `enableActivityTracking()` instead | 
| Deprecation     | JavaScript tracker      | `trackEvent()` deprecated      | Use `trackStructEvent()` instead       |
| Data change     | S3 & Infobright storage | `event`="custom" changed       | Changed to `event`="struct"            |

The first three changes are simply cleanup: we are removing tracker methods which we previously deprecated some time ago.

The last two changes are us starting to re-structure our event tracking - we are making space in our event model to support unstructured events, which will be coming soon. Please check out our previous blog post, [Help us build out the SnowPlow Event Model] [event-model-blog-post] for more background on this.


<a name="upgrade"><h2>4. Upgrading</h2></a>

Upgrading is a three-step process:

### 4.1 JavaScript tracker

Please update your website(s) to use the latest version of the JavaScript tracker, which is version 0.10.0. As always, the updated minified tracker is available here:

    http(s)://d1fc8wv8zag5ca.cloudfront.net/0.10.0/sp.js

**Don't forget to update your SnowPlow tags as per the updates in [breaking changes] (#breaking-changes) and deprecations above.**

### 4.2 ETL

If you are using EmrEtlRunner, you need to update your configuration file, `config.yml`, to use the latest versions of the Hive serde and HiveQL scripts:

    :snowplow:
      :serde_version: 0.5.4
      :hive_hiveql_version: 0.5.5
      :non_hive_hiveql_version: 0.0.6

### 4.3 Infobright

If you are using Infobright Community Edition for analysis, you will need to update your table definition. To make this easier for you, we have created two scripts:

    4-storage/infobright-storage/migrate_004_to_006.sh
    4-storage/infobright-storage/migrate_005_to_006.sh

Choose the appropriate script depending on whether your current events table is `events_004` or `events_005`.

Running this script will create a new table, `events_006` (version 0.0.6 of the Infobright table definition) in your `snowplow` database, copying across all your data from your existing `events` table, which will not be modified in any way.

Once you have run this, don't forget to update your StorageLoader's `config.yml` to load into the new `events_006` table, not your old `events` table:

    :storage:
      :type: infobright
      :database: snowplow
      :table:    events_006 # NOT "events_004" or "events_005" any more

Done!

## 5. Getting help

As always, if you do run into any issues or don't understand any of the above changes, please [raise an issue] [issues] or get in touch with us via [the usual channels] [talk-to-us].

[shermozle]: https://github.com/shermozle
[angus-mark]: https://github.com/ngsmrk
[simply-business]: http://www.simplybusiness.co.uk/

[issues]: https://github.com/snowplow/snowplow/issues
[talk-to-us]: https://github.com/snowplow/snowplow/wiki/Talk-to-us
